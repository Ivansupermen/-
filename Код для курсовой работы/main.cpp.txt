#include <iostream>
#include <string>
#include <limits>
#include <cmath>
#include <iomanip>

using namespace std;

void show_menu();
void calculate_cost(double loan, double interest, double tax, double add_costs);
void get_user_input_and_calculate();
void test_calculation();

int main() {
    cout << " СИСТЕМА ОЦЕНКИ СТОИМОСТИ ЗАЕМНОГО КАПИТАЛА " << endl;

    int choice;
    while (true) {
        show_menu();
        if (!(cin >> choice)) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "ОШИБК! Выберите 1, 2 или 3." << endl;
            continue;
        }
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        switch (choice) {
            case 1:
                get_user_input_and_calculate();
                break;
            case 2:
                test_calculation();
                break;
            case 3:
                cout << "ВЫХОД" << endl;
                return 0;
            default:
                cout << "ОШИБКА! Выберите 1, 2 или 3." << endl;
        }
    }
    return 0;
}

void show_menu() {
    cout << "\n ГЛАВНОЕ МЕНЮ " << endl;
    cout << "1. Расчет стоимости заемного капитала" << endl;
    cout << "2. Тестирование" << endl;
    cout << "3. ВЫХОД" << endl;
    cout << "Выберите действие: ";
}

void get_user_input_and_calculate() {
    double loan, interest, tax, add_costs;

    cout << "\n ВВОД ПАРАМЕТРОВ " << endl;

    while (true) {
        cout << "Сумма займа (0.01 - 1e12): ";
        if (cin >> loan && loan >= 0.01 && loan <= 1e12) break;
        cout << "ОШИБКА! Введите число от 0.01 до 1e12." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    while (true) {
        cout << "Годовые проценты (0 - 1e12): ";
        if (cin >> interest && interest >= 0 && interest <= 1e12) break;
        cout << "ОШИБКА! Введите число от 0 до 1e12." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    while (true) {
        cout << "Налоговая ставка (0-1): ";
        if (cin >> tax && tax >= 0 && tax <= 1) break;
        cout << "ОШИБКА! Введите число от 0 до 1." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    while (true) {
        cout << "Дополнительные расходы (0 - 1e12): ";
        if (cin >> add_costs && add_costs >= 0 && add_costs <= 1e12) break;
        cout << "ОШИБКА! Введите число от 0 до 1e12." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    calculate_cost(loan, interest, tax, add_costs);
}

void calculate_cost(double loan, double interest, double tax, double add_costs) {
    double nominal_cost = (interest / loan) * 100.0;
    double after_tax_cost = nominal_cost * (1.0 - tax);
    double effective_rate = (pow(1.0 + nominal_cost / 100.0, 1.0) - 1.0) * 100.0;
    effective_rate += (add_costs / loan) * 100.0;

    cout << fixed << setprecision(2);
    cout << "\n РЕЗУЛЬТАТЫ " << endl;
    cout << "Стоимость заемного капитала: " << nominal_cost << "%" << endl;
    cout << "Стоимость после налога: " << after_tax_cost << "%" << endl;
    cout << "Эффективная ставка: " << effective_rate << "%" << endl;
}

void test_calculation() {
    cout << "\n ТЕСТИРОВАНИЕ " << endl;

    cout << "\nТест 1: [1000000, 80000, 0.2, 0.2]" << endl;
    calculate_cost(1000000, 80000, 0.2, 0.2);

    cout << "\nТест 2: [500000, 60000, 0.15, 0.25]" << endl;
    calculate_cost(500000, 60000, 0.15, 0.25);

    cout << "\n ТЕСТИРОВАНИЕ ЗАВЕРШЕНО " << endl;
}
