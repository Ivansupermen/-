#include <iostream>
#include <string>
#include <limits>
#include <cmath>
#include <iomanip>

using namespace std;

void show_menu();
void calculate_cost(double loan, double interest, double tax, double add_costs);
void get_user_input_and_calculate();
void test_calculation();

int main() {
    setlocale(LC_ALL, "Russian");

    cout << " СИСТЕМА ОЦЕНКИ СТОИМОСТИ ЗАЕМНОГО КАПИТАЛА " << endl;

    int choice;
    while (true) {
        show_menu();
        cin >> choice;
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        switch (choice) {
            case 1:
                get_user_input_and_calculate();
                break;
            case 2:
                test_calculation();
                break;
            case 3:
                cout << "Выход.." << endl;
                return 0;
            default:
                cout << "Ошибка! Выберите 1, 2 или 3." << endl;
        }
    }
}

void show_menu() {
    cout << "\n ГЛАВНОЕ МЕНЮ " << endl;
    cout << "1. Расчет стоимости заемного капитала" << endl;
    cout << "2. Тестирование" << endl;
    cout << "3. Выход" << endl;
    cout << "Выберите действие: ";
}

void get_user_input_and_calculate() {
    double loan, interest, tax, add_costs;

    cout << "\n ВВОД ПАРАМЕТРОВ " << endl;

    // Вводим сумму займа
    while (true) {
        cout << "Сумма займа (0.01 - 1e12): ";
        if (cin >> loan && loan >= 0.01 && loan <= 1e12) break;
        cout << "Ошибка! Введите число от 0.01 до 1e12." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    // Вводи годовые проценты
    while (true) {
        cout << "Годовые проценты (0 - 1e12): ";
        if (cin >> interest && interest >= 0 && interest <= 1e12) break;
        cout << "Ошибка! Введите число от 0 до 1e12." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    // Вводим налоговую ставку
    while (true) {
        cout << "Налоговая ставка (0-1, например 0.2 для 20%): ";
        if (cin >> tax && tax >= 0 && tax <= 1) break;
        cout << "Ошибка! Введите число от 0 до 1." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    // Вводим дополнительные расходы
    while (true) {
        cout << "Дополнительные расходы (0 - 1e12): ";
        if (cin >> add_costs && add_costs >= 0 && add_costs <= 1e12) break;
        cout << "Ошибка! Введите число от 0 до 1e12." << endl;
        cin.clear();
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    calculate_cost(loan, interest, tax, add_costs);
}

void calculate_cost(double loan, double interest, double tax, double add_costs) {
    // 1. Номинальная стоимость заемного капитала
    double nominal_cost = (interest / loan) * 100;
    
    // 2. Стоимость после налога
    double after_tax_cost = nominal_cost * (1 - tax);
    
    // 3. Эффективная годовая ставка с учетом дополнительных расходов
    // Формула: эффективная ставка = ((interest + add_costs) / loan) * 100
    double effective_rate = ((interest + add_costs) / loan) * 100;

    cout << fixed << setprecision(2);
    cout << "\n РЕЗУЛЬТАТЫ " << endl;
    cout << "Стоимость заемного капитала: " << nominal_cost << "%" << endl;
    cout << "Стоимость после налога: " << after_tax_cost << "%" << endl;
    cout << "Эффективная ставка: " << effective_rate << "%" << endl;
}

void test_calculation() {
    cout << "\n ТЕСТИРОВАНИЕ " << endl;

    // Тест 1: [1000000, 80000, 0.2, 0.2]
    cout << "\nТест 1: [1000000, 80000, 0.2, 0.2]" << endl;
    calculate_cost(1000000, 80000, 0.2, 0.2);

    // Тест 2: [500000, 60000, 0.15, 0.25]
    cout << "\nТест 2: [500000, 60000, 0.15, 0.25]" << endl;
    calculate_cost(500000, 60000, 0.15, 0.25);

    cout << "\n ТЕСТИРОВАНИЕ ЗАВЕРШЕНО " << endl;
}
